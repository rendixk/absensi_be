// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL") // ignore this issue. because I've changed this version to 6, not 7. because Prisma 7 doesn't support MySQL fully.
}

enum Status_Kehadiran {
  hadir
  sakit
  izin
  alfa
  missing
}

enum Role {
  wali_kelas
  guru
  admin
  guru_bk
}

enum QR_Code_Type {
  clock_in
  clock_out
}

model admin {
  id       Int    @id @default(autoincrement())
  username String @unique
  password String
  role     Role   @default(admin)
}

model wali_kelas {
  id             Int     @id @default(autoincrement())
  username       String  @unique
  nip            String
  mapel          String
  password       String
  role           Role    @default(wali_kelas)

  //relasi
  kelas kelas?
}

model kelas {
  id            Int    @id @default(autoincrement())
  nama_kelas    String @unique
  password      String
  wali_kelas_id Int?    @unique
  guru_id       Int?   @unique
  created_at    DateTime @default(now())
  updated_at    DateTime?

  //relasi
  siswa         siswa[]
  absensi       absensi[]
  rekap_absensi rekap_absensi[]
  qr_token      qr_token?

  wali_kelas wali_kelas? @relation(fields: [wali_kelas_id], references: [id])
  guru       guru?       @relation(fields: [guru_id], references: [id])
}

model guru {
  id       Int    @id @default(autoincrement())
  username String @unique
  nip      String
  mapel    String
  password String
  role     Role   @default(guru)

  //relasi
  kelas      kelas?
}

model siswa {
  id           Int    @id @default(autoincrement())
  username     String @unique
  nama_lengkap String
  password     String
  nis          String
  nomor_wali   String
  kelas_id     Int

  //relasi
  absensi       absensi[]
  rekap_absensi rekap_absensi[]
  surat_peringatan  surat_peringatan[]
  kelas         kelas           @relation(fields: [kelas_id], references: [id])
}

model absensi {
  id               Int              @id @default(autoincrement())
  tanggal          DateTime         @default(now())
  siswa_id         Int
  kelas_id         Int
  status           Status_Kehadiran
  clock_in         DateTime?
  clock_out        DateTime?

  //relasi
  siswa            siswa             @relation(fields: [siswa_id], references: [id])
  kelas            kelas             @relation(fields: [kelas_id], references: [id])
}

model rekap_absensi {
  id         Int @id @default(autoincrement())
  siswa_id   Int
  kelas_id   Int
  guru_bk_id Int
  bulan      Int
  tahun      Int

  total_hadir Int @default(0)
  total_sakit Int @default(0)
  total_izin  Int @default(0)
  total_alpha Int @default(0)

  //relasi
  surat_peringatan  surat_peringatan[]
  siswa   siswa     @relation(fields: [siswa_id], references: [id])
  kelas   kelas     @relation(fields: [kelas_id], references: [id])
  guru_bk guru_bk   @relation(fields: [guru_bk_id], references: [id])

  @@unique([siswa_id, kelas_id, bulan, tahun])
}

model guru_bk {
  id       Int    @id @default(autoincrement())
  username String @unique
  nip      String
  password String
  role     Role   @default(guru_bk)

  rekap_absensi rekap_absensi[]
}

model surat_peringatan {
  id          Int    @id @default(autoincrement())
  siswa_id    Int
  rekap_absensi_id Int
  judul_surat   String
  tanggal_terbit  DateTime @default(now())
  file        String

  //relasi
  rekap_absensi rekap_absensi @relation(fields: [rekap_absensi_id], references: [id])
  siswa siswa @relation(fields: [siswa_id], references: [id])
}

model qr_token {
  id         Int           @id @default(autoincrement())
  token      String        @unique
  created_at DateTime      @default(now())
  expired_at DateTime
  used       Boolean       @default(false)
  kelas_id   Int           @unique
  qrtype     QR_Code_Type?

  //relasi
  kelas kelas @relation(fields: [kelas_id], references: [id])
}
